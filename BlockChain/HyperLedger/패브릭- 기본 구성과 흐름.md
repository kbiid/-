<h2>클라이언트(Client)</h2>

블록 체인에 접근하기 위해 필요한 노드(node). 피어에게 보내는 거래(트랜잭션, transaction)을 만든다. 채널을 생성하거나 특정 피어를 채널에 참가하게 하는 트랜잭션 같은 특수한 트랜잭션들 또한 여기서 생성된다.
하이퍼레저 패브릭에서는 보통 도커 이미지를 이용해 제공되는 클라이언트 어플리케이션을 이용하거나 별도의 어플리케이션을 통해서 블록체인 네트워크와 통신을 한다.
클라이언트는 트랜잭션을 생성하여 피어 노드의 엔도저(endoser, 보증)에 보내는(sumbit) 일을  한다. 이후 거래 보증응답이 오면 거래 제안(transaction proposal)을 생성하여 Orderer(오더러, OSN)에게 보낸다.

<h2>피어(Peer)</h2>

원장(ledger, chain)을 가진 패브릭에서 가장 기본이 되는 노드이다. 체인코드(smart contract) 또한 여기에 들어있다. 자신에게 요청된 트랜잭션을 검증하고 전파한다. 오더러로부터 트랜잭션을 받으면 원장을 갱신한다. 이후 원장이 업데이트 된 것을 클라이언트에게 알려(event)준다. 피어는 다중 체인 코드와 다중 원장을 사용할 수 있다.(채널을 이용)

하이퍼레저 패브릭은 체인코드 동작을 위해 키-값 데이터베이스(Key-Value Database)를 사용한다. 하이퍼레저 패브릭은 이러한 KVS(Key Value Store)중 기본적(Default)으로 LevelDB를 사용한다. 조금 더 복잡한 DB를 구성하기 위해서 카우치DB(CouchDB)를 사용한다.

앵커(Anchor)는 조직에 속한 다른 피어들을 검색가능하게 해준다. peer-to-peer간의 gossip이 가능하도록 해준다. 트랜잭션을 조직내의 다른 피어로 전달시킨다. 조직내에 속한 피어 하나가 앵커로 동작하며 채널에는 반드시 하나 이상의 앵커 피어가 존재한다. 

엔도저(Endorser)는 트랜잭션이 발생할경우 이곳에 거래 제안(transaction proposal)의 형태로 온다. 보통 체인코드가 설치되어있고 트랜잭션을 시뮬레이션 해보고 불안정할 경우 차단한다. 엔도저가 직접 원장을 업데이트 하지는 않는다. 간단히 요약하면 체인코드가 설치된 피어들이다.

커미터(Commiter)는 블록을 전달받아 블록 내의 모든 트랜잭션을 검사하고 블록을 체인에 연결한다. 트랜잭션이 유효하다면 원장을 업데이트를 한다. 간단히 요약하면 기본 기능만 하는 피어들이다.

<h2>OSN(Ordering Service Node, Orderer)</h2>

검증된 트랜잭션들을 이용해 최종적으로 블록을 만든다. 합의 알고리즘에 따라 클라리언트들로부터 오는 거래(transaction proposal)들을 순서화시켜 피어 노드에 전달한다. 피어로 전달되는 거래들이 안전하게 전달되는 것을 보장한다.

오더러는 방대한 양의 트랜잭션을 검증하고 이들을 모아서 블록을 생성하는 작업을 한다. 트랜잭션이 많아지면 당연히 오버헤드가 걸리게 된다. 이를 위해 사용하는 것이 MQ Solution(message queue)이다. 발생한 트랜잭션들을 MQ에 적재해서 처리해서 오더러가 부하를 견디도록 도와주는 역할을 한다. 보통 kafka나 zookeeper를 사용한다. RAFT라는 것도 있다.

<h2>기본적인 흐름 정리</h2>

<ol>
  <li>클라이언트 어플리케이션이 피어에 연결한다.</li>
  <li>연결이 되면 트랜잭션을 생성(transaction proposal)해서 피어의 endorser에 보낸다.</li>
  <li>피어는 받은 거래제안(transaction proposal)에 대하여 체인코드를 확인한다.</li>
  <li>체인코드는 원장에 대한 쿼리 거래(ledger query transaction)의 경우 즉시 결과를 반환한다.</li>
  <li>update와 같은 원장(ledger)에 대한 변경이 있는 거래 제안이었을 경우 피어는 받은 거래 제안에 대한 응답(response)을 한다.</li>
  <li>응답을 받은 클라이언트는 해당 거래는 오더러(OSN)에 보낸다.</li>
  <li>오더러는 합의 알고리즘에 의거해서 블록을 생성하고 이를 피어로 보낸다.</li>
  <li>피어의 앵커(anchor)는 오더러로부터 받은 거래블록(transaction block)을 받고 커미터(committer)가 트랜잭션을 확정한다. 또한 이를 이용해서 피
  어는 원장을 업데이트 한다. 이후 클라이언트에게 업데이트 이벤트를 보낸다.</li>
  <li>클라이언트는 업데이트 이벤트를 받게되고 트랜잭션 과정이 끝난다.</li>
</ol>

<h2>참고사이트</h2>

- https://hcnam.tistory.com/19
